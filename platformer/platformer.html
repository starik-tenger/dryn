<!doctype html>
<html>
<style>
   * {
    margin: 0;
    padding: 0;
   }
 </style>
<canvas height=900 width=900 id="screen"></canvas>
<script>
	window.addEventListener('keydown',this.check,true);
	
	var screen = document.getElementById("screen");
	ctx     = screen.getContext('2d');
    ctx.imageSmoothingEnabled = false;
	
	player = new Image();              
		player.src = 'textures/player.bmp';	
    block = new Image();              
		block.src = 'textures/blocks/block.bmp';
	sky = new Image();              
		sky.src = 'textures/sky.jpg';
	door = new Image();              
		door.src = 'textures/blocks/door.bmp';
    


	//клавиши
	const up = 38;
	const right = 39;
	const left = 37;
	const space = 32;
	
	

	
	var camX = 0;
	var camY = 0;
	var leftBlock = 0;
	var rightBlock = 0;
	var upBlock = 0;
	var downBlock = 0;
	var playerX = 70;
	var playerY = 70;
	var playerSpeed = 15;
	var playerSize = 50;
	var playerCellX = 0;
	var playerCellY = 0;
	var forceX = 0;
	var forceY = 0;
	var playerA = 40;
	var gravity = 3;
	var friction = 3;
	var pixel = 1;
	camX = playerX-450;
	
	//игровые объекты
	var blocks = [
	[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
	[1,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
	[1,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
	[1,0,0,0,0,0,0,0,0,0,0,1,0,1,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
	[1,0,0,0,0,0,0,1,0,1,1,0,0,1,0,0,0,1,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
	[1,0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
	[1,0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0,1,0,0,0,0,1,0,1,1,1,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
	[1,0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0,1,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
	[1,0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
	[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
	];
	var size = 60;
	var sizeX = blocks.length;
	var sizeY = blocks[0].length;

	var doors = [];
	function setDoor(x, y, endX, endY)
	{
		doors.push({x: x, y: y, endX: endX, endY: endY});
	}
	
	function pairDoors(x,y,x1,y1)
	{
		setDoor(x,y,x1,y1+1);   
		setDoor(x1,y1,x,y+1);   
	}
	
	function checkWindow()
	{
		screen.height = document.documentElement.clientHeight;
		screen.width = document.documentElement.clientWidth;
		ctx.imageSmoothingEnabled = false;
		pixel = screen.height/500;
		//pixel = Math.round(pixel);
	}
	
	function cell()
	{
		playerCellX = Math.floor((playerX)/size);
		playerCellY = Math.floor((playerY)/size);
	}
	
	function playerIn(x, y, x1, y1)
	{
		return (playerX>=x && playerY>=y && playerX<=x1 && playerY<=y1);
	}

	pairDoors(19,7,15,7)
	
	
	function draw()
	{
		ctx.drawImage(sky, 0, 0, screen.width , screen.height);
		for(x=0; x<sizeY; x++)
		{
			for(y=0; y<sizeX ;y++)
			{
				if(blocks[y][x] == 1)
					{      
						ctx.fillRect(((x*size)-camX)*pixel, ((y*size)-camY)*pixel, size*pixel, size*pixel);
						ctx.drawImage(block, ((x*size)-camX)*pixel, ((y*size)-camY)*pixel, size*pixel, size*pixel);
					}else if(blocks[y][x] == 2)
					{       
						ctx.fillRect(((x*size)-camX)*pixel, ((y*size)-camY)*pixel, size*pixel, size*pixel);
						
					}
			}
		}
		for(i=0; i<doors.length; i++)
		{
			ctx.drawImage(door, (doors[i].x*size-camX)*pixel, (doors[i].y*size-camY)*pixel, size*pixel, size*2*pixel);
		}
		ctx.drawImage(player, (playerX-camX)*pixel, (playerY-camY)*pixel, (playerSize)*pixel, playerSize*pixel);
		
	}
	var key;
	function check(e)                                    
	{
		key = e.keyCode;
	}
	
	function checkBlocks()
	{
		if((blocks[playerCellY+1][playerCellX]==1 || blocks[playerCellY+1][playerCellX-1]==1 && Math.abs((playerCellX-1)*size-playerX)<playerSize ||blocks[playerCellY+1][playerCellX+1]==1 && Math.abs((playerCellX+1)*size-playerX)<playerSize) && Math.abs((playerCellY+1)*size-playerY)<=playerSize)
		{
			downBlock = 1;
			
			
		}else
		{
			downBlock = 0;
		}
		if((blocks[playerCellY-1][playerCellX]==1 || blocks[playerCellY-1][playerCellX-1]==1 && Math.abs((playerCellX-1)*size-playerX)<playerSize ||blocks[playerCellY-1][playerCellX+1]==1 && Math.abs((playerCellX+1)*size-playerX)<playerSize) && Math.abs((playerCellY-1)*size-playerY)<=size)
		{
			upBlock = 1; 
		}else
		{
			upBlock = 0;
		}
		if((blocks[playerCellY][playerCellX+1]==1 || blocks[playerCellY+1][playerCellX+1]==1 && Math.abs((playerCellY+1)*size-playerY)<playerSize || blocks[playerCellY-1][playerCellX+1]==1 && Math.abs((playerCellY-1)*size-playerY)<playerSize) && Math.abs((playerCellX+1)*size-playerX)<=playerSize)
		{
			rightBlock = 1;console.log("RIGHT");
		}else
		{
			rightBlock = 0;
		}
		
		if((blocks[playerCellY][playerCellX-1]==1 || blocks[playerCellY+1][playerCellX-1]==1 && Math.abs((playerCellY+1)*size-playerY)<playerSize || blocks[playerCellY-1][playerCellX-1]==1 && Math.abs((playerCellY-1)*size-playerY)<playerSize) && Math.abs((playerCellX-1)*size-playerX)<=size)
		{
			leftBlock = 1;console.log("LEFT");
		}else
		{
			leftBlock = 0;
		}
	}
	
	function move()
	{
		cell();
		checkBlocks();
		if(key==right)
		{
			forceX = playerSpeed;
		}else if(forceX>0 && downBlock==1)
		{
			forceX-=friction;
		}
		
		if(key==left)
		{
			forceX = -playerSpeed;
		}else if(forceX<0 && downBlock==1)
		{
			forceX+=friction;
		}
		if(key==up && downBlock==1)
		{
			forceY = -playerA;
		}
		
		if(downBlock == 0)
		{
			forceY+=gravity;
		}
		
		
		
		
		for(i=0; i<Math.abs(forceY); i++)
		{
			cell();
			checkBlocks();
			if(downBlock == 0 && forceY>0)
			{
				playerY+=1;
			}
			if(upBlock == 0 && forceY<0)
			{
				playerY-=1;
			}else if(upBlock == 1 || downBlock == 1 && key!=up)
			{
				forceY = 0;
			}
		}
		for(i=0; i<Math.abs(forceX); i++)
		{
			cell();
			checkBlocks();
			if(rightBlock == 0 && forceX>0)
			{
				playerX+=1;
			}
			if(leftBlock == 0 && forceX<0)
			{
				playerX-=1;
			}
			if(rightBlock == 1 || leftBlock == 1)
			{
				forceX = 0;
			}
		}
		
		if(rightBlock==1)
		{
			playerX-=1;
		}
		if(leftBlock==1)
		{
			playerX+=1;
		}
		
		
		//console.log(Math.abs((playerCellY+1)*size-playerY));
	}
		
	function camera()
	{
		
		camX += (playerX-screen.width/(2*pixel)-camX)/10;
		camY += (playerY-screen.height/(2*pixel)-camY)/10;
		
		camX = Math.round(camX);
		camY = Math.round(camY);
	}
	
	function checkDoors()
	{
		for(i=0; i<doors.length; i++)
		{
			if(playerIn(doors[i].x*size, doors[i].y*size, doors[i].x*size+size, doors[i].y*size+size*2) && key==space)
			{
				playerX = doors[i].endX*size;
				playerY = doors[i].endY*size;
				console.log(i);
				key = 0;
			}
		}
	}
	
	function play()
	{
		checkWindow();
		move();
		camera();
		checkDoors();
		
		key = 0;
		draw();
	}
	draw();
	setInterval(play, 50);
</script>