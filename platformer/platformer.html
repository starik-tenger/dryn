<!doctype html>
<html>
<style>
   * {
    margin: 0;
    padding: 0;
   }
 </style>
<canvas height=900 width=900 id="screen" onmousedown = "checkMouse()" onmouseup = "resetMouse()"></canvas>
<script>
	window.addEventListener('keydown',this.check,false);
	window.addEventListener('keyup',this.reset,false);
	
	var screen = document.getElementById("screen");
	ctx     = screen.getContext('2d');
    ctx.imageSmoothingEnabled = false;
	
	var playerImg = new Image();              
		playerImg.src = 'textures/player.bmp';	
	var monster = new Image();              
		monster.src = 'textures/monster.bmp';	
	var grass = new Image();              
		grass.src = 'textures/blocks/grass.bmp';
    var dirt = new Image();              
		dirt.src = 'textures/blocks/dirt.bmp';
	var spikes = new Image();              
		spikes.src = 'textures/blocks/spikes.png';
	var sky = new Image();              
		sky.src = 'textures/sky.jpg';
	var door = new Image();              
		door.src = 'textures/blocks/door.bmp';
	var exit = new Image();              
		exit.src = 'textures/blocks/exit.bmp';
	var button = new Image();              
		button.src = 'textures/blocks/button.bmp';
    
	var doorSound = new Audio('sounds/door.mp3');
	var buttonSound = new Audio('sounds/button.mp3');
	var walkSound = new Audio('sounds/walk.mp3');
	var deathSound = new Audio('sounds/death.mp3');
	

	//клавиши
	const up = 87;
	const right = 68;
	const left = 65;
	const down = 83;
	const space = 32;
	
	var scale = 500;
	var keyX = 0;
	var keyY = 0;
	
	const EXIT = 666;
	
	var size = 60;
	var camX = 0;
	var camY = 0;
	var leftBlock = 0;
	var rightBlock = 0;
	var upBlock = 0;
	var downBlock = 0;
	var player = {};
	player.x = 1*size;
	player.y = 1*size;
	player.speed = 15;
	player.size = 50;
	player.cellX = 0;
	player.cellY = 0;
	player.forceX = 0;
	player.forceY = 0;
	player.A = 5;
	var gravity = 3;
	var friction = 5;
	var signal = 0;
	var pixel = 1;
	camX = player.x-450;
	
	
	var mouseX = 0;
	var mouseY = 0;
	function checkMouse()
	{
		mouseX = event.pageX/pixel;
		mouseY = event.pageY/pixel;
	}
	
	function resetMouse()
	{
		mouseX = screen.width/(2*pixel);
		mouseY = screen.height/(2*pixel);
	}
	
	function getCookie(name) {
  var matches = document.cookie.match(new RegExp(
    "(?:^|; )" + name.replace(/([\.$?*|{}\(\)\[\]\\\/\+^])/g, '\\$1') + "=([^;]*)"
  ));
  return matches ? decodeURIComponent(matches[1]) : undefined;
}
	
	var level = 0;
	var levels = [];
	
	//уровни
	{ //level 0
		levels.push({});
		levels[0].setup = function()
		{
			blocks = [
		[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
		[1,_,_,_,_,1,_,_,_,_,_,_,_,_,_,_,_,1,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,1,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,1,_,_,_,_,_,_,_,_,_,_,_,_,_,1],
		[1,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,1,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,1,1,1,1,1,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,1,_,_,_,_,_,_,_,_,_,_,_,_,_,1],
		[1,_,_,_,_,_,_,_,_,_,_,1,_,1,_,_,_,1,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,1,1,1,_,_,_,_,_,_,_,_,_,_,_,_,_,1],
		[1,_,_,_,_,_,_,1,_,1,1,_,_,1,_,_,_,1,_,_,_,_,_,_,_,_,_,1,1,1,_,_,1,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,1,_,_,_,_,_,_,_,_,_,_,_,_,_,1],
		[1,_,_,_,_,1,_,_,_,_,_,_,_,1,_,_,1,1,_,_,_,_,_,_,_,_,_,_,_,1,_,_,1,1,1,1,1,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,1,_,_,_,1,1,1,1,1,_,_,_,_,_,1],
		[1,_,_,_,_,1,_,_,_,_,_,_,_,1,_,_,_,1,_,_,_,_,1,1,1,1,1,1,1,1,_,_,_,_,_,_,1,1,_,_,_,_,_,_,_,_,_,_,_,_,_,_,1,1,1,1,1,_,_,_,1,_,_,_,_,_,_,_,_,_,1],
		[1,_,_,_,_,1,_,_,_,_,_,_,_,1,_,_,_,1,_,_,_,1,1,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,1,1,1,1,1,_,_,_,_,_,_,_,_,_,_,_,_,_,1,_,_,_,1,_,_,_,_,_,_,_,_,_,1],
		[1,_,_,_,_,1,_,_,_,_,_,_,_,1,_,_,_,1,_,_,_,1,_,_,_,_,_,_,_,_,_,_,_,_,_,1,1,_,_,_,_,_,1,2,2,2,_,_,_,1,_,_,_,_,_,_,1,_,_,_,1,_,_,_,_,_,_,2,2,2,1],
		[1,1,1,1,1,1,1,1,1,1,1,1,_,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,_,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
		[1,_,_,_,_,_,_,_,_,_,_,1,_,_,_,_,_,_,_,1,_,_,_,_,_,_,_,_,1,_,_,_,_,_,_,_,_,_,_,_,_,_,1,_,_,_,_,_,1,_,_,_,_,_,_,_,1,_,_,_,_,_,_,_,_,_,_,_,_,_,1],
		[1,_,_,_,_,_,_,_,_,_,_,1,_,_,_,_,_,_,_,1,_,_,_,1,1,_,_,_,1,_,_,_,1,1,1,1,_,_,_,_,_,_,1,_,_,_,_,_,1,_,_,_,_,_,_,_,1,_,_,_,_,_,_,_,_,_,_,_,_,_,1],
		[1,1,1,1,1,1,1,1,1,_,_,1,1,1,1,1,1,1,1,1,_,_,1,1,1,1,_,_,1,1,1,1,1,_,_,1,1,1,1,1,1,1,1,1,1,1,_,_,1,_,_,_,_,_,_,_,1,_,_,_,_,_,_,_,_,_,_,_,_,_,1],
		[1,_,_,_,_,_,_,_,_,_,_,_,_,_,1,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,1,_,_,_,_,_,_,_,_,_,1,_,_,_,_,_,_,_,_,_,_,1,1,1,1,_,_,_,_,_,_,_,_,_,_,_,_,_,1],
		[1,_,_,_,_,_,_,_,_,1,1,1,_,_,1,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,1,1,1,_,_,_,_,_,_,_,1,_,_,_,_,_,_,_,_,_,1,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,1],
		[1,_,_,_,_,_,_,_,_,_,_,1,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,1,_,_,_,_,_,_,_,_,_,1,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,1],
		[1,_,_,_,_,_,_,_,_,_,_,1,_,_,1,1,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,1,_,_,_,_,_,_,_,_,_,1,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,1],
		[1,_,_,_,_,_,_,_,_,_,_,1,_,_,1,_,_,_,_,_,2,2,2,2,2,2,2,2,_,_,_,_,_,_,_,_,_,_,_,_,_,_,1,_,_,_,_,_,_,_,_,_,1,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,1],
		[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
		];
	
		setButton(2,17, EXIT);
		pairDoors(19,8,15,8,true);//0,1
		pairDoors(18,11,29,11,false);//2,3
		pairDoors(43,11,41,17,false);//4,5
		pairDoors(23,8,58,8,true);//6,7
		setButton(8,8,1);
		setButton(55,2,2);
		setButton(47,17,3);
		setButton(33,13,4);
		setButton(62,8,5);
		setMonster(47*size,14*size);
		player.x = 2*size;
		player.y = 1*size;
		signal = 0;
		}
		
		levels[0].play = function()
		{
			if(signal==1)
			{
				doors[0].lock = !doors[0].lock;
				doors[1].lock = !doors[1].lock;
				signal = 0;
			}
			if(signal==2)
			{
				blocks[9][55] = 0;
				signal = 0;
			}
			if(signal==3)
			{
				jump(6*size);
				signal = 0;
			}
			if(signal==4)
			{
				doors[6].lock = !doors[6].lock;
				doors[7].lock = !doors[7].lock;
				signal = 0;
			}
			if(signal==5)
			{
				blocks[14][27] = 1;
				signal = 0;
			}
			
		}
	}
	
	{ //level 1
		levels.push({});
		levels[1].setup = function()
		{
			blocks = [
		[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
		[1,_,_,_,_,_,_,_,1,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,1],
		[1,_,_,_,_,_,_,_,1,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,1],
		[1,_,_,_,_,_,_,_,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,_,_,_,1,1,1,1,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,1],
		[1,1,1,1,1,1,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,1],
		[1,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,1],
		[1,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,1],
		[1,1,1,1,1,1,1,1,_,_,_,_,_,1,1,1,1,1,1,1,1,1,1,_,_,_,1,1,1,1,1,1,1,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,1],
		[1,_,_,_,_,_,_,1,2,2,2,2,2,1,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,1],
		[1,_,_,_,_,_,_,1,1,1,1,1,1,1,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,1],
		[1,1,1,1,1,1,1,1,_,_,_,_,_,1,_,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
		];
	
		
		player.x = 2*size;
		player.y = 2*size;
		signal = 0;
	
		}
		levels[1].play = function()
		{
			
		}
	}
	
	var _ = 0;
	
	//игровые объекты
	var blocks = [];
	
	var sizeX;
	var sizeY;

	var doors = [];
	
	var monsters = []
	
	function setMonster(x,y)
	{
	
	
		monsters.push({x: x, y: y, size: 50, cellX:0 , cellY:0})
		var monster = monsters[monsters.length-1];
		
		
		monster.cellX = 0;
		monster.cellY = 0;
		monster.forceX = 0;
		monster.forceY = 0;
		monster.direction = right;
		monster.downBlock = 0;
		monster.rightBlock = 0;
		monster.leftBlock = 0;
		
		
		monster.cell = function()
		{
			monster.cellX = Math.floor((monster.x)/size);
			monster.cellY = Math.floor((monster.y)/size);
		}
		
		monster.checkBlocks = function()
		{
		
			monster.cell();
			if((blocks[monster.cellY+1][monster.cellX]==1 || blocks[monster.cellY+1][monster.cellX-1]==1 && Math.abs((monster.cellX-1)*size-monster.x)<monster.size ||blocks[monster.cellY+1][monster.cellX+1]==1 && Math.abs((monster.cellX+1)*size-monster.x)<monster.size) && Math.abs((monster.cellY+1)*size-monster.y)<=monster.size)
			{monster.downBlock = 1;}else{monster.downBlock = 0;}
			
			if((blocks[monster.cellY][monster.cellX+1]!=0 || blocks[monster.cellY+1][monster.cellX+1]!=0 && Math.abs((monster.cellY+1)*size-monster.y)<monster.size || blocks[monster.cellY-1][monster.cellX+1]!=0 && Math.abs((monster.cellY-1)*size-monster.y)<monster.size) && Math.abs((monster.cellX+1)*size-monster.x)<=monster.size)
			{monster.rightBlock = 1;}else{monster.rightBlock = 0;}
		
			if((blocks[monster.cellY][monster.cellX-1]!=0 || blocks[monster.cellY+1][monster.cellX-1]!=0 && Math.abs((monster.cellY+1)*size-monster.y)<monster.size || blocks[monster.cellY-1][monster.cellX-1]!=0 && Math.abs((monster.cellY-1)*size-monster.y)<monster.size) && Math.abs((monster.cellX-1)*size-monster.x)<=size)
			{monster.leftBlock = 1;}else{monster.leftBlock = 0;}
			
			if((blocks[monster.cellY-1][monster.cellX]==1 || blocks[monster.cellY-1][monster.cellX-1]==1 && Math.abs((monster.cellX-1)*size-monster.x)<monster.size ||blocks[monster.cellY-1][monster.cellX+1]==1 && Math.abs((monster.cellX+1)*size-monster.x)<monster.size) && Math.abs((monster.cellY-1)*size-monster.y)<=size)
			{monster.upBlock = 1;}else{monster.upBlock = 0;}}
		
		monster.move = function()
		{
			for(i=0; i<Math.abs(monster.forceY); i++)
			{
				monster.cell();
				monster.checkBlocks();
				if(monster.downBlock == 0 && monster.forceY>0)
				{
					monster.y+=1;
				}
				if(monster.upBlock == 0 && monster.forceY<0)
				{
					monster.y-=1;
				}else if(monster.upBlock == 1 || monster.downBlock == 1 && keyY!=up)
				{
					monster.forceY = 0;
				}
			}
			for(i=0; i<Math.abs(monster.forceX); i++)
			{
				monster.cell();
				monster.checkBlocks();
				if(monster.rightBlock == 0 && monster.forceX>0)
				{
					monster.x+=1;
				}
				if(monster.leftBlock == 0 && monster.forceX<0)
				{
					monster.x-=1;
				}
				if(monster.rightBlock == 1 || monster.leftBlock == 1)
				{
					monster.forceX = 0;
				}
			}
			
			monster.checkBlocks();
			if(monster.downBlock==0)
			{
				monster.forceY+=gravity;
			}
			if(monster.direction==right)
			{
				monster.forceX=5;
			}else if(monster.direction==left)
			{
				monster.forceX=-5;
			}else
			{
				monster.forceX=0;
			}	
		}
		
		monster.think = function()
		{
			if(monster.rightBlock==1)
			{
				monster.direction=left;monster.forceY=-10;
			}
			if(monster.leftBlock==1)
			{
				monster.direction=right;monster.forceY=-10;
			}
			if(playerIn(monster.x, monster.y, monster.x+monster.size, monster.y+monster.size))
			{
				deathSound.play();
				start();
			}
		}
	}
	
	function setDoor(x, y, endX, endY, lock)
	{
		doors.push({x: x, y: y-1, endX: endX, endY: endY-1, lock: lock});
	}
	
	function pairDoors(x,y,x1,y1,lock)
	{
		setDoor(x,y,x1,y1+1,lock);   
		setDoor(x1,y1,x,y+1,lock);   
	}
	
	var buttons = [];
	function setButton(x, y, signal)
	{
		buttons.push({x: x, y: y, signal: signal});
	}
	
	function exit(x, y)
	{
		buttons.push({x: x, y: y, signal: EXIT});
	}
	
	function checkWindow()
	{
		screen.height = document.documentElement.clientHeight-4;
		screen.width = document.documentElement.clientWidth;
		ctx.imageSmoothingEnabled = false;
		pixel = screen.height/scale;
		//pixel = Math.round(pixel);
	}
	
	player.cell = function()
	{
		player.cellX = Math.floor((player.x)/size);
		player.cellY = Math.floor((player.y)/size);
	}
	
	function playerIn(x, y, x1, y1)
	{
		return (player.x+size/2>=x && player.y+size/2>=y && player.x+size/2<=x1 && player.y+size/2<=y1);
	}

	
	
	function drawLine(startPointX, startPointY, endPointX, endPointY)
	{
		ctx.beginPath();
		ctx.moveTo(startPointX*pixel, startPointY*pixel);
		ctx.lineTo(endPointX*pixel, endPointY*pixel);
		ctx.stroke();
	}
	
	//отрисовка
	function draw()
	{
		ctx.drawImage(sky, 0, 0, screen.width , screen.height);
		for(x=0; x<sizeY; x++)
		{
			for(y=0; y<sizeX ;y++)
			{
				if(blocks[y][x] == 1)
					{      
						ctx.fillRect(((x*size)-camX)*pixel, ((y*size)-camY)*pixel, size*pixel, size*pixel);
						if(y!=0 && blocks[y-1][x]!=0)
						{
							ctx.drawImage(dirt, ((x*size)-camX)*pixel, ((y*size)-camY)*pixel, size*pixel, size*pixel);
						}else
						{
							ctx.drawImage(grass, ((x*size)-camX)*pixel, ((y*size)-camY)*pixel, size*pixel, size*pixel);
						}
					}else if(blocks[y][x] == 2)
					{       
						ctx.drawImage(spikes, ((x*size)-camX)*pixel, ((y*size)-camY)*pixel, size*pixel, size*pixel);
						
					}
			}
		}
		//двери
		for(i=0; i<doors.length; i++)
		{
			ctx.drawImage(door, (doors[i].x*size-camX)*pixel, (doors[i].y*size-camY)*pixel, size*pixel, size*2*pixel);
			if(doors[i].lock)
			{
				ctx.save;
				ctx.strokeStyle = "rgb(255,0,0)";
				ctx.lineWidth = size/10*pixel;
				drawLine((doors[i].x*size-camX), (doors[i].y*size-camY), doors[i].x*size-camX+size, doors[i].y*size-camY+size*2);
				drawLine((doors[i].x*size-camX), (doors[i].y*size-camY)+size*2, doors[i].x*size-camX+size, doors[i].y*size-camY);
				ctx.restore;
			}
		}
		
		for(i=0; i<buttons.length; i++)
		{
			if(buttons[i].signal == EXIT)
			{
				ctx.drawImage(exit, (buttons[i].x*size-camX)*pixel, (buttons[i].y*size-size-camY)*pixel, size*pixel, size*pixel*2);
			}
		}
		
		ctx.drawImage(playerImg, (player.x-camX)*pixel, (player.y-camY)*pixel, (player.size)*pixel, player.size*pixel);
		
		//кнопки
		for(i=0; i<buttons.length; i++)
		{
			if(buttons[i].signal != EXIT)
			{
				ctx.drawImage(button, (buttons[i].x*size-camX)*pixel, (buttons[i].y*size-camY)*pixel, size*pixel, size*pixel);
			}

		}
		
		//monsters
		for(i=0; i<monsters.length; i++)
		{
			ctx.drawImage(monster, (monsters[i].x-camX)*pixel, (monsters[i].y-camY)*pixel, monsters[i].size*pixel, monsters[i].size*pixel);
		}
		
	}
	
	var key;
	var direction;
	function check(e)                                    
	{
		key = e.keyCode;
		if(key==right)
		{
			keyX=right;
		}
		if(key==left)
		{
			keyX=left;
		}
		if(key==up)
		{
			keyY=up;
		}
		console.log(key);
		
	}
	
	function reset(e)
	{
		key = e.keyCode;
		if(key==right || key==left)
		{
			keyX=0;
		}
		if(key==up)
		{
			keyY=0;
		}
		key = 0;
	}
	player.checkBlocks = function()
	{
		if((blocks[player.cellY+1][player.cellX]==1 || blocks[player.cellY+1][player.cellX-1]==1 && Math.abs((player.cellX-1)*size-player.x)<player.size ||blocks[player.cellY+1][player.cellX+1]==1 && Math.abs((player.cellX+1)*size-player.x)<player.size) && Math.abs((player.cellY+1)*size-player.y)<=player.size)
		{
			downBlock = 1;
			
			
		}else
		{
			downBlock = 0;
		}
		if((blocks[player.cellY-1][player.cellX]==1 || blocks[player.cellY-1][player.cellX-1]==1 && Math.abs((player.cellX-1)*size-player.x)<player.size ||blocks[player.cellY-1][player.cellX+1]==1 && Math.abs((player.cellX+1)*size-player.x)<player.size) && Math.abs((player.cellY-1)*size-player.y)<=size)
		{
			upBlock = 1; 
		}else
		{
			upBlock = 0;
		}
		if((blocks[player.cellY][player.cellX+1]!=0 || blocks[player.cellY+1][player.cellX+1]!=0 && Math.abs((player.cellY+1)*size-player.y)<player.size || blocks[player.cellY-1][player.cellX+1]!=0 && Math.abs((player.cellY-1)*size-player.y)<player.size) && Math.abs((player.cellX+1)*size-player.x)<=player.size)
		{
			rightBlock = 1;
		}else
		{
			rightBlock = 0;
		}
		
		if((blocks[player.cellY][player.cellX-1]!=0 || blocks[player.cellY+1][player.cellX-1]!=0 && Math.abs((player.cellY+1)*size-player.y)<player.size || blocks[player.cellY-1][player.cellX-1]!=0 && Math.abs((player.cellY-1)*size-player.y)<player.size) && Math.abs((player.cellX-1)*size-player.x)<=size)
		{
			leftBlock = 1;
		}else
		{
			leftBlock = 0;
		}
	}
	
	function jump(h)
	{
		player.forceY = -Math.sqrt(2*gravity*h);
	}

	player.move = function()
	{
		player.cell();
		player.checkBlocks();
		if(keyX==right && player.forceX<=player.speed)
		{
			player.forceX += player.A;
			if(player.forceX>player.speed || downBlock==0){player.forceX=player.speed;}
		}else if(player.forceX>0 && downBlock==1)
		{
			player.forceX-=friction;
			if(player.forceX<0){player.forceX=0;}
		}
		if(keyX==left && player.forceX>=-player.speed)
		{
			player.forceX -= player.A;
			if(player.forceX<-player.speed || downBlock==0){player.forceX=-player.speed;}
		}else if(player.forceX<0 && downBlock==1)
		{
			player.forceX+=friction;
			if(player.forceX>0){player.forceX=0;}
		}
		
		if(keyY==up && downBlock==1)
		{
			jump(4*size);
		}
		
		if(downBlock == 0)
		{
			player.forceY+=gravity;
		}
		
		
		
		
		for(i=0; i<Math.abs(player.forceY); i++)
		{
			player.cell();
			player.checkBlocks();
			if(downBlock == 0 && player.forceY>0)
			{
				player.y+=1;
			}
			if(upBlock == 0 && player.forceY<0)
			{
				player.y-=1;
			}else if(upBlock == 1 || downBlock == 1 && keyY!=up)
			{
				player.forceY = 0;
			}
		}
		for(i=0; i<Math.abs(player.forceX); i++)
		{
			player.cell();
			player.checkBlocks();
			if(rightBlock == 0 && player.forceX>0)
			{
				player.x+=1;
			}
			if(leftBlock == 0 && player.forceX<0)
			{
				player.x-=1;
			}
			if(rightBlock == 1 || leftBlock == 1)
			{
				player.forceX = 0;
			}
		}
		
		if(blocks[player.cellY][Math.floor((player.x+size/2)/size)]==2)
		{
			deathSound.play();
			start();
		}
		
		if(rightBlock==1)
		{
			player.x-=1;
		}
		if(leftBlock==1)
		{
			player.x+=1;
		}
		
		
		//console.log(Math.abs((player.cellY+1)*size-player.y));
	}
		

	var centerX = screen.width/(2*pixel);
	var centerY = screen.height/(2*pixel);
	var camX = 0;
	var camY = 0;
	function camera()
	{
		centerX = screen.width/pixel-mouseX;
		centerY = screen.height/pixel-mouseY;
		camX += (player.x-centerX-camX)/20;
		camY += (player.y-centerY-camY)/20;
		
		camX = Math.round(camX);
		camY = Math.round(camY);
	}
	
	function checkDoors()
	{
		for(i=0; i<doors.length; i++)
		{
			if(playerIn(doors[i].x*size, doors[i].y*size, doors[i].x*size+size, doors[i].y*size+size*2) && key==space)
			{
				if(!doors[i].lock)
				{
					player.x = doors[i].endX*size;
					player.y = doors[i].endY*size;
					doorSound.play();
					key = 0;
				}
			}
		}
	}
	
	function checkButtons()
	{
		for(i=0; i<buttons.length; i++)
		{
			if(playerIn(buttons[i].x*size, buttons[i].y*size, buttons[i].x*size+size, buttons[i].y*size+size) && key==space)
			{
				signal = buttons[i].signal;
				if(buttons[i].signal == EXIT)
				{
					doorSound.play();
				}else{
					buttonSound.play();
				}
				key = 0;
			}
		}
	}
	
	var date = new Date(new Date().getTime() + 10000000);
	function start()
	{
		doors = [];
		buttons = [];
		monsters = [];
		levels[level].setup();
		sizeX = blocks.length;
		sizeY = blocks[0].length;
		document.cookie = "level="+level+"expires=" + date.toUTCString();
	}
	start();

	if(document.cookie != "")
	{
		level = getCookie("level");
	}
	var time=0;
	function step()
	{
	
		player.forceX1 = player.forceX;
		checkWindow();
		player.move();
		/*if(key==up)
		{
			player.y-=20;
		}
		if(key==down)
		{
			player.y+=20;
		}
		if(key==right)
		{
			player.x+=20;
		}
		if(key==left)
		{
			player.x-=20;
		}*/
		camera();
		checkDoors();
		checkButtons();
		levels[level].play();
		if(signal == EXIT)
		{
			level++;
			start();
		}
		if(player.forceX!=0 && player.forceX1==0 && downBlock==1)
		{	
			walkSound.play();
		}
		if(player.forceX!=0 && time%6==0 && downBlock==1)
		{	
			walkSound.play();
		}
		//player.cell();
		//console.log(player.cellX, player.cellY);
		
		//key = 0;
		time++;
		draw();
		for(var i=0;i<monsters.length;i++)
		{
			monsters[i].think();
			monsters[i].move();
		}

		
	}
	draw();
	setInterval(step, 50);
</script>