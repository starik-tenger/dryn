<!doctype html>
<html>
<style>
   * {
    margin: 0;
    padding: 0;
   }
 </style>
<canvas height=900 width=900 id="screen"></canvas>
<script>
	window.addEventListener('keydown',this.check,false);
	window.addEventListener('keydown',this.check1,false);
	
	var screen = document.getElementById("screen");
	ctx     = screen.getContext('2d');
    ctx.imageSmoothingEnabled = false;
	
	player = new Image();              
		player.src = 'textures/player.bmp';	
    block = new Image();              
		block.src = 'textures/blocks/block.bmp';
	spikes = new Image();              
		spikes.src = 'textures/blocks/spikes.png';
	sky = new Image();              
		sky.src = 'textures/sky.jpg';
	door = new Image();              
		door.src = 'textures/blocks/door.bmp';
	exit = new Image();              
		exit.src = 'textures/blocks/exit.bmp';
	button = new Image();              
		button.src = 'textures/blocks/button.bmp';
    


	//клавиши
	const up = 38;
	const right = 39;
	const left = 37;
	const space = 32;
	
	
	const EXIT = 666;
	
	var size = 60;
	var camX = 0;
	var camY = 0;
	var leftBlock = 0;
	var rightBlock = 0;
	var upBlock = 0;
	var downBlock = 0;
	var playerX = 1*size;
	var playerY = 1*size;
	var playerSpeed = 15;
	var playerSize = 50;
	var playerCellX = 0;
	var playerCellY = 0;
	var forceX = 0;
	var forceY = 0;
	var playerA = 40;
	var gravity = 3;
	var friction = 3;
	var signal = 0;
	var pixel = 1;
	camX = playerX-450;
	
	var level = 0;
	var levels = [];
	
	//уровни
	{ //level 0
		levels.push({});
		levels[0].setup = function()
		{
			blocks = [
		[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
		[1,_,_,_,_,1,_,_,_,_,_,_,_,_,_,_,_,1,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,1,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,1,_,_,_,_,_,_,_,_,_,_,_,_,_,1],
		[1,_,_,_,_,1,_,_,_,_,_,_,_,_,_,_,_,1,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,1,1,1,1,1,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,1,_,_,_,_,_,_,_,_,_,_,_,_,_,1],
		[1,_,_,_,_,_,_,_,_,_,_,1,_,1,_,_,_,1,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,1,1,1,_,_,_,_,_,_,_,_,_,_,_,_,_,1],
		[1,_,_,_,_,_,_,1,_,1,1,_,_,1,_,_,_,1,_,_,_,_,_,_,_,_,_,1,1,1,_,_,1,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,1,_,_,_,_,_,_,_,_,_,_,_,_,_,1],
		[1,_,_,_,_,1,_,_,_,_,_,_,_,1,_,_,1,1,_,_,_,_,_,_,_,_,_,_,_,1,_,_,1,1,1,1,1,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,1,_,_,_,1,_,_,_,_,_,_,_,_,_,1],
		[1,_,_,_,_,1,_,_,_,_,_,_,_,1,_,_,_,1,_,_,_,_,1,1,1,1,1,1,1,1,_,_,_,_,_,_,1,1,_,_,_,_,_,_,_,_,_,_,_,_,_,_,1,1,1,1,1,_,_,_,_,_,_,_,_,_,_,_,_,_,1],
		[1,_,_,_,_,1,_,_,_,_,_,_,_,1,_,_,_,1,_,_,_,1,1,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,1,1,1,1,1,_,_,_,_,_,_,_,_,_,_,_,_,_,1,_,_,_,_,_,_,_,_,_,_,_,_,_,1],
		[1,_,_,_,_,1,_,_,_,_,_,_,_,1,_,_,_,1,_,_,_,1,_,_,_,_,_,_,_,_,_,_,_,_,_,1,1,_,_,_,_,_,1,2,2,2,_,_,_,1,_,_,_,_,_,_,1,_,_,_,_,_,_,_,_,_,_,_,_,_,1],
		[1,1,1,1,1,1,1,1,1,1,1,1,_,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,_,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
		[1,_,_,_,_,_,_,_,_,_,_,1,_,_,_,_,_,_,_,1,_,_,_,_,_,_,_,_,1,_,_,_,_,_,_,_,_,_,_,_,_,_,1,_,_,_,_,_,1,_,_,_,_,_,_,_,1,_,_,_,_,_,_,_,_,_,_,_,_,_,1],
		[1,_,_,_,_,_,_,_,_,_,_,1,_,_,_,_,_,_,_,1,_,_,_,_,_,_,_,_,1,_,_,_,1,1,1,1,_,_,_,_,_,_,1,_,_,_,_,_,1,_,_,_,_,_,_,_,1,_,_,_,_,_,_,_,_,_,_,_,_,_,1],
		[1,_,_,_,_,_,_,_,_,_,_,1,1,1,1,1,1,1,1,1,_,_,_,_,_,_,_,_,1,1,1,1,1,_,_,1,1,1,1,1,1,1,1,1,1,1,_,_,1,_,_,_,_,_,_,_,1,_,_,_,_,_,_,_,_,_,_,_,_,_,1],
		[1,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,1,_,_,_,_,_,_,_,_,_,_,1,1,1,1,_,_,_,_,_,_,_,_,_,_,_,_,_,1],
		[1,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,1,_,_,_,_,_,_,_,_,_,1,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,1],
		[1,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,1,_,_,_,_,_,_,_,_,_,1,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,1],
		[1,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,1,_,_,_,_,_,_,_,_,_,1,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,1],
		[1,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,1,_,_,_,_,_,_,_,_,_,1,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,1],
		[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
		];
	
		setButton(35,17, EXIT);
		pairDoors(19,7,15,7,true);
		pairDoors(18,10,29,10,false);
		pairDoors(43,10,41,16,false);
		setButton(8,8,1);
		setButton(55,2,2);
		setButton(47,17,3);
		playerX = 1*size;
		playerY = 1*size;
		signal = 0;
		}
		
		levels[0].play = function()
		{
			if(signal==1)
			{
				doors[0].lock = !doors[0].lock;
				doors[1].lock = !doors[1].lock;
				signal = 0;
			}
			if(signal==2)
			{
				blocks[9][55] = 0;
				signal = 0;
			}
			if(signal==3)
			{
				jump(6*size);
				signal = 0;
			}
			
		}
	}
	
	{ //level 1
		levels.push({});
		levels[1].setup = function()
		{
			blocks = [
		[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
		[1,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,1],
		[1,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,1],
		[1,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,1],
		[1,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,1],
		[1,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,1],
		[1,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,1],
		[1,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,1],
		[1,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,1],
		[1,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,1],
		[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
		];
	
		
		playerX = 2*size;
		playerY = 2*size;
		signal = 0;
	
		}
		levels[1].play = function()
		{
			
		}
	}
	
	var _ = 0;
	
	//игровые объекты
	var blocks = [];
	
	var sizeX;
	var sizeY;

	var doors = [];
	function setDoor(x, y, endX, endY, lock)
	{
		doors.push({x: x, y: y, endX: endX, endY: endY, lock: lock});
	}
	
	function pairDoors(x,y,x1,y1,lock)
	{
		setDoor(x,y,x1,y1+1,lock);   
		setDoor(x1,y1,x,y+1,lock);   
	}
	
	var buttons = [];
	function setButton(x, y, signal)
	{
		buttons.push({x: x, y: y, signal: signal});
	}
	
	function exit(x, y)
	{
		buttons.push({x: x, y: y, signal: EXIT});
	}
	
	function checkWindow()
	{
		screen.height = document.documentElement.clientHeight-4;
		screen.width = document.documentElement.clientWidth;
		ctx.imageSmoothingEnabled = false;
		pixel = screen.height/500;
		//pixel = Math.round(pixel);
	}
	
	function cell()
	{
		playerCellX = Math.floor((playerX)/size);
		playerCellY = Math.floor((playerY)/size);
	}
	
	function playerIn(x, y, x1, y1)
	{
		return (playerX+size/2>=x && playerY+size/2>=y && playerX+size/2<=x1 && playerY+size/2<=y1);
	}

	
	
	function drawLine(startPointX, startPointY, endPointX, endPointY)
	{
		ctx.beginPath();
		ctx.moveTo(startPointX*pixel, startPointY*pixel);
		ctx.lineTo(endPointX*pixel, endPointY*pixel);
		ctx.stroke();
	}
	
	//отрисовка
	function draw()
	{
		ctx.drawImage(sky, 0, 0, screen.width , screen.height);
		for(x=0; x<sizeY; x++)
		{
			for(y=0; y<sizeX ;y++)
			{
				if(blocks[y][x] == 1)
					{      
						ctx.fillRect(((x*size)-camX)*pixel, ((y*size)-camY)*pixel, size*pixel, size*pixel);
						ctx.drawImage(block, ((x*size)-camX)*pixel, ((y*size)-camY)*pixel, size*pixel, size*pixel);
					}else if(blocks[y][x] == 2)
					{       
						ctx.drawImage(spikes, ((x*size)-camX)*pixel, ((y*size)-camY)*pixel, size*pixel, size*pixel);
						
					}
			}
		}
		//двери
		for(i=0; i<doors.length; i++)
		{
			ctx.drawImage(door, (doors[i].x*size-camX)*pixel, (doors[i].y*size-camY)*pixel, size*pixel, size*2*pixel);
			if(doors[i].lock)
			{
				ctx.save;
				ctx.strokeStyle = "rgb(255,0,0)";
				ctx.lineWidth = size/10*pixel;
				drawLine((doors[i].x*size-camX), (doors[i].y*size-camY), doors[i].x*size-camX+size, doors[i].y*size-camY+size*2);
				drawLine((doors[i].x*size-camX), (doors[i].y*size-camY)+size*2, doors[i].x*size-camX+size, doors[i].y*size-camY);
				ctx.restore;
			}
		}
		
		for(i=0; i<buttons.length; i++)
		{
			if(buttons[i].signal == EXIT)
			{
				ctx.drawImage(exit, (buttons[i].x*size-camX)*pixel, (buttons[i].y*size-size-camY)*pixel, size*pixel, size*pixel*2);
			}
		}
		
		ctx.drawImage(player, (playerX-camX)*pixel, (playerY-camY)*pixel, (playerSize)*pixel, playerSize*pixel);
		
		//кнопки
		for(i=0; i<buttons.length; i++)
		{
			if(buttons[i].signal != EXIT)
			{
				ctx.drawImage(button, (buttons[i].x*size-camX)*pixel, (buttons[i].y*size-camY)*pixel, size*pixel, size*pixel);
			}

		}
		
	}
	
	var key;
	function check(e)                                    
	{
		key = e.keyCode;
	}
	
	function checkBlocks()
	{
		if((blocks[playerCellY+1][playerCellX]==1 || blocks[playerCellY+1][playerCellX-1]==1 && Math.abs((playerCellX-1)*size-playerX)<playerSize ||blocks[playerCellY+1][playerCellX+1]==1 && Math.abs((playerCellX+1)*size-playerX)<playerSize) && Math.abs((playerCellY+1)*size-playerY)<=playerSize)
		{
			downBlock = 1;
			
			
		}else
		{
			downBlock = 0;
		}
		if((blocks[playerCellY-1][playerCellX]==1 || blocks[playerCellY-1][playerCellX-1]==1 && Math.abs((playerCellX-1)*size-playerX)<playerSize ||blocks[playerCellY-1][playerCellX+1]==1 && Math.abs((playerCellX+1)*size-playerX)<playerSize) && Math.abs((playerCellY-1)*size-playerY)<=size)
		{
			upBlock = 1; 
		}else
		{
			upBlock = 0;
		}
		if((blocks[playerCellY][playerCellX+1]!=0 || blocks[playerCellY+1][playerCellX+1]!=0 && Math.abs((playerCellY+1)*size-playerY)<playerSize || blocks[playerCellY-1][playerCellX+1]!=0 && Math.abs((playerCellY-1)*size-playerY)<playerSize) && Math.abs((playerCellX+1)*size-playerX)<=playerSize)
		{
			rightBlock = 1;console.log("RIGHT");
		}else
		{
			rightBlock = 0;
		}
		
		if((blocks[playerCellY][playerCellX-1]!=0 || blocks[playerCellY+1][playerCellX-1]!=0 && Math.abs((playerCellY+1)*size-playerY)<playerSize || blocks[playerCellY-1][playerCellX-1]!=0 && Math.abs((playerCellY-1)*size-playerY)<playerSize) && Math.abs((playerCellX-1)*size-playerX)<=size)
		{
			leftBlock = 1;console.log("LEFT");
		}else
		{
			leftBlock = 0;
		}
	}
	
	function jump(h)
	{
		forceY = -Math.sqrt(2*gravity*h);
	}

	function move()
	{
		cell();
		checkBlocks();
		if(key==right)
		{
			forceX = playerSpeed;
		}else if(forceX>0 && downBlock==1)
		{
			forceX-=friction;
		}
		
		if(key==left)
		{
			forceX = -playerSpeed;
		}else if(forceX<0 && downBlock==1)
		{
			forceX+=friction;
		}
		if(key==up && downBlock==1)
		{
			jump(4*size);
		}
		
		if(downBlock == 0)
		{
			forceY+=gravity;
		}
		
		
		
		
		for(i=0; i<Math.abs(forceY); i++)
		{
			cell();
			checkBlocks();
			if(downBlock == 0 && forceY>0)
			{
				playerY+=1;
			}
			if(upBlock == 0 && forceY<0)
			{
				playerY-=1;
			}else if(upBlock == 1 || downBlock == 1 && key!=up)
			{
				forceY = 0;
			}
		}
		for(i=0; i<Math.abs(forceX); i++)
		{
			cell();
			checkBlocks();
			if(rightBlock == 0 && forceX>0)
			{
				playerX+=1;
			}
			if(leftBlock == 0 && forceX<0)
			{
				playerX-=1;
			}
			if(rightBlock == 1 || leftBlock == 1)
			{
				forceX = 0;
			}
		}
		
		if(blocks[playerCellY][Math.floor((playerX+size/2)/size)]==2)
		{
			start();
		}
		
		if(rightBlock==1)
		{
			playerX-=1;
		}
		if(leftBlock==1)
		{
			playerX+=1;
		}
		
		
		//console.log(Math.abs((playerCellY+1)*size-playerY));
	}
		
	function camera()
	{
		
		camX += (playerX-screen.width/(2*pixel)-camX)/10;
		camY += (playerY-screen.height/(2*pixel)-camY)/10;
		
		camX = Math.round(camX);
		camY = Math.round(camY);
	}
	
	function checkDoors()
	{
		for(i=0; i<doors.length; i++)
		{
			if(playerIn(doors[i].x*size, doors[i].y*size, doors[i].x*size+size, doors[i].y*size+size*2) && !doors[i].lock && key==space)
			{
				playerX = doors[i].endX*size;
				playerY = doors[i].endY*size;
				key = 0;
			}
		}
	}
	
	function checkButtons()
	{
		for(i=0; i<buttons.length; i++)
		{
			if(playerIn(buttons[i].x*size, buttons[i].y*size, buttons[i].x*size+size, buttons[i].y*size+size) && key==space)
			{
				signal = buttons[i].signal;
				console.log(signal);
				key = 0;
			}
		}
	}
	
	function start()
	{
		doors = [];
		buttons = [];
		levels[level].setup();
		sizeX = blocks.length;
		sizeY = blocks[0].length;
	}
	
	start();
	
	
	function step()
	{
		checkWindow();
		move();
		camera();
		checkDoors();
		checkButtons();
		levels[level].play();
		if(signal == EXIT)
		{
			level++;
			start();
		}
		console.log(key);
		key = 0;
		draw();
		
	}
	draw();
	setInterval(step, 50);
</script>