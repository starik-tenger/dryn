<!doctype html>
<html>
<style>
   * {
    margin: 0;
    padding: 0;
   }
 </style>
<canvas height=900 width=900 id="screen"></canvas>
<script>
	window.addEventListener('keydown',this.check,false);
	window.addEventListener('keyup',this.reset,false);
	
	var screen = document.getElementById("screen");
	ctx     = screen.getContext('2d');
    ctx.imageSmoothingEnabled = false;
	
	var player = new Image();              
		player.src = 'textures/player.bmp';	
	var grass = new Image();              
		grass.src = 'textures/blocks/grass.bmp';
    var dirt = new Image();              
		dirt.src = 'textures/blocks/dirt.bmp';
	var spikes = new Image();              
		spikes.src = 'textures/blocks/spikes.png';
	var sky = new Image();              
		sky.src = 'textures/sky.jpg';
	var door = new Image();              
		door.src = 'textures/blocks/door.bmp';
	var exit = new Image();              
		exit.src = 'textures/blocks/exit.bmp';
	var button = new Image();              
		button.src = 'textures/blocks/button.bmp';
    
	var doorSound = new Audio('sounds/door.mp3');
	var buttonSound = new Audio('sounds/button.mp3');
	var walkSound = new Audio('sounds/walk.mp3');
	var deathSound = new Audio('sounds/death.mp3');
	

	//клавиши
	const up = 38;
	const right = 39;
	const left = 37;
	const down = 40;
	const space = 32;
	
	var keyX = 0;
	var keyY = 0;
	
	const EXIT = 666;
	
	var size = 60;
	var camX = 0;
	var camY = 0;
	var leftBlock = 0;
	var rightBlock = 0;
	var upBlock = 0;
	var downBlock = 0;
	var playerX = 1*size;
	var playerY = 1*size;
	var playerSpeed = 15;
	var playerSize = 50;
	var playerCellX = 0;
	var playerCellY = 0;
	var forceX = 0;
	var forceY = 0;
	var playerA = 5;
	var gravity = 3;
	var friction = 5;
	var signal = 0;
	var pixel = 1;
	var scale = 500;
	camX = playerX-450;
	
	
	var level = 0;
	var levels = [];
	
	//уровни
	{ //level 0
		levels.push({});
		levels[0].setup = function()
		{
			blocks = [
		[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
		[1,_,_,_,_,1,_,_,_,_,_,_,_,_,_,_,_,1,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,1,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,1,_,_,_,_,_,_,_,_,_,_,_,_,_,1],
		[1,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,1,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,1,1,1,1,1,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,1,_,_,_,_,_,_,_,_,_,_,_,_,_,1],
		[1,_,_,_,_,_,_,_,_,_,_,1,_,1,_,_,_,1,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,1,1,1,_,_,_,_,_,_,_,_,_,_,_,_,_,1],
		[1,_,_,_,_,_,_,1,_,1,1,_,_,1,_,_,_,1,_,_,_,_,_,_,_,_,_,1,1,1,_,_,1,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,1,_,_,_,_,_,_,_,_,_,_,_,_,_,1],
		[1,_,_,_,_,1,_,_,_,_,_,_,_,1,_,_,1,1,_,_,_,_,_,_,_,_,_,_,_,1,_,_,1,1,1,1,1,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,1,_,_,_,1,1,1,1,1,_,_,_,_,_,1],
		[1,_,_,_,_,1,_,_,_,_,_,_,_,1,_,_,_,1,_,_,_,_,1,1,1,1,1,1,1,1,_,_,_,_,_,_,1,1,_,_,_,_,_,_,_,_,_,_,_,_,_,_,1,1,1,1,1,_,_,_,1,_,_,_,_,_,_,_,_,_,1],
		[1,_,_,_,_,1,_,_,_,_,_,_,_,1,_,_,_,1,_,_,_,1,1,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,1,1,1,1,1,_,_,_,_,_,_,_,_,_,_,_,_,_,1,_,_,_,1,_,_,_,_,_,_,_,_,_,1],
		[1,_,_,_,_,1,_,_,_,_,_,_,_,1,_,_,_,1,_,_,_,1,_,_,_,_,_,_,_,_,_,_,_,_,_,1,1,_,_,_,_,_,1,2,2,2,_,_,_,1,_,_,_,_,_,_,1,_,_,_,1,_,_,_,_,_,_,2,2,2,1],
		[1,1,1,1,1,1,1,1,1,1,1,1,_,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,_,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
		[1,_,_,_,_,_,_,_,_,_,_,1,_,_,_,_,_,_,_,1,_,_,_,_,_,_,_,_,1,_,_,_,_,_,_,_,_,_,_,_,_,_,1,_,_,_,_,_,1,_,_,_,_,_,_,_,1,_,_,_,_,_,_,_,_,_,_,_,_,_,1],
		[1,_,_,_,_,_,_,_,_,_,_,1,_,_,_,_,_,_,_,1,_,_,_,1,1,_,_,_,1,_,_,_,1,1,1,1,_,_,_,_,_,_,1,_,_,_,_,_,1,_,_,_,_,_,_,_,1,_,_,_,_,_,_,_,_,_,_,_,_,_,1],
		[1,1,1,1,1,1,1,1,1,_,_,1,1,1,1,1,1,1,1,1,_,_,1,1,1,1,_,_,1,1,1,1,1,_,_,1,1,1,1,1,1,1,1,1,1,1,_,_,1,_,_,_,_,_,_,_,1,_,_,_,_,_,_,_,_,_,_,_,_,_,1],
		[1,_,_,_,_,_,_,_,_,_,_,_,_,_,1,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,1,_,_,_,_,_,_,_,_,_,1,_,_,_,_,_,_,_,_,_,_,1,1,1,1,_,_,_,_,_,_,_,_,_,_,_,_,_,1],
		[1,_,_,_,_,_,_,_,_,1,1,1,_,_,1,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,1,1,1,_,_,_,_,_,_,_,1,_,_,_,_,_,_,_,_,_,1,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,1],
		[1,_,_,_,_,_,_,_,_,_,_,1,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,1,_,_,_,_,_,_,_,_,_,1,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,1],
		[1,_,_,_,_,_,_,_,_,_,_,1,_,_,1,1,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,1,_,_,_,_,_,_,_,_,_,1,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,1],
		[1,_,_,_,_,_,_,_,_,_,_,1,_,_,1,_,_,_,_,_,2,2,2,2,2,2,2,2,_,_,_,_,_,_,_,_,_,_,_,_,_,_,1,_,_,_,_,_,_,_,_,_,1,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,1],
		[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
		];
	
		setButton(2,17, EXIT);
		pairDoors(19,8,15,8,true);//0,1
		pairDoors(18,11,29,11,false);//2,3
		pairDoors(43,11,41,17,false);//4,5
		pairDoors(23,8,58,8,true);//6,7
		setButton(8,8,1);
		setButton(55,2,2);
		setButton(47,17,3);
		setButton(33,13,4);
		setButton(62,8,5);
		playerX = 1*size;
		playerY = 1*size;
		signal = 0;
		}
		
		levels[0].play = function()
		{
			if(signal==1)
			{
				doors[0].lock = !doors[0].lock;
				doors[1].lock = !doors[1].lock;
				signal = 0;
			}
			if(signal==2)
			{
				blocks[9][55] = 0;
				signal = 0;
			}
			if(signal==3)
			{
				jump(6*size);
				signal = 0;
			}
			if(signal==4)
			{
				doors[6].lock = !doors[6].lock;
				doors[7].lock = !doors[7].lock;
				signal = 0;
			}
			if(signal==5)
			{
				blocks[17][23] = 0;
				blocks[17][24] = 0;
				signal = 0;
			}
			
		}
	}
	
	{ //level 1
		levels.push({});
		levels[1].setup = function()
		{
			blocks = [
		[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
		[1,_,_,_,_,_,_,_,1,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,1],
		[1,_,_,_,_,_,_,_,1,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,1],
		[1,_,_,_,_,_,_,_,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,_,_,_,1,1,1,1,1,1,1,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,1],
		[1,1,1,1,1,1,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,1],
		[1,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,1],
		[1,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,1],
		[1,1,1,1,1,1,1,1,_,_,_,_,_,1,1,1,1,1,1,1,1,1,1,_,_,_,1,1,1,1,1,1,1,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,1],
		[1,_,_,_,_,_,_,1,2,2,2,2,2,1,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,1],
		[1,_,_,_,_,_,_,1,1,1,1,1,1,1,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,1],
		[1,1,1,1,1,1,1,1,_,_,_,_,_,1,_,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
		];
	
		
		playerX = 2*size;
		playerY = 2*size;
		signal = 0;
	
		}
		levels[1].play = function()
		{
			
		}
	}
	
	var _ = 0;
	
	//игровые объекты
	var blocks = [];
	
	var sizeX;
	var sizeY;

	var doors = [];
	function setDoor(x, y, endX, endY, lock)
	{
		doors.push({x: x, y: y-1, endX: endX, endY: endY-1, lock: lock});
	}
	
	function pairDoors(x,y,x1,y1,lock)
	{
		setDoor(x,y,x1,y1+1,lock);   
		setDoor(x1,y1,x,y+1,lock);   
	}
	
	var buttons = [];
	function setButton(x, y, signal)
	{
		buttons.push({x: x, y: y, signal: signal});
	}
	
	function exit(x, y)
	{
		buttons.push({x: x, y: y, signal: EXIT});
	}
	
	function checkWindow()
	{
		screen.height = document.documentElement.clientHeight-4;
		screen.width = document.documentElement.clientWidth;
		ctx.imageSmoothingEnabled = false;
		pixel = screen.height/scale;
		//pixel = Math.round(pixel);
	}
	
	function cell()
	{
		playerCellX = Math.floor((playerX)/size);
		playerCellY = Math.floor((playerY)/size);
	}
	
	function playerIn(x, y, x1, y1)
	{
		return (playerX+size/2>=x && playerY+size/2>=y && playerX+size/2<=x1 && playerY+size/2<=y1);
	}

	
	
	function drawLine(startPointX, startPointY, endPointX, endPointY)
	{
		ctx.beginPath();
		ctx.moveTo(startPointX*pixel, startPointY*pixel);
		ctx.lineTo(endPointX*pixel, endPointY*pixel);
		ctx.stroke();
	}
	
	//отрисовка
	function draw()
	{
		ctx.drawImage(sky, 0, 0, screen.width , screen.height);
		for(x=0; x<sizeY; x++)
		{
			for(y=0; y<sizeX ;y++)
			{
				if(blocks[y][x] == 1)
					{      
						ctx.fillRect(((x*size)-camX)*pixel, ((y*size)-camY)*pixel, size*pixel, size*pixel);
						if(y!=0 && blocks[y-1][x]!=0)
						{
							ctx.drawImage(dirt, ((x*size)-camX)*pixel, ((y*size)-camY)*pixel, size*pixel, size*pixel);
						}else
						{
							ctx.drawImage(grass, ((x*size)-camX)*pixel, ((y*size)-camY)*pixel, size*pixel, size*pixel);
						}
					}else if(blocks[y][x] == 2)
					{       
						ctx.drawImage(spikes, ((x*size)-camX)*pixel, ((y*size)-camY)*pixel, size*pixel, size*pixel);
						
					}
			}
		}
		//двери
		for(i=0; i<doors.length; i++)
		{
			ctx.drawImage(door, (doors[i].x*size-camX)*pixel, (doors[i].y*size-camY)*pixel, size*pixel, size*2*pixel);
			if(doors[i].lock)
			{
				ctx.save;
				ctx.strokeStyle = "rgb(255,0,0)";
				ctx.lineWidth = size/10*pixel;
				drawLine((doors[i].x*size-camX), (doors[i].y*size-camY), doors[i].x*size-camX+size, doors[i].y*size-camY+size*2);
				drawLine((doors[i].x*size-camX), (doors[i].y*size-camY)+size*2, doors[i].x*size-camX+size, doors[i].y*size-camY);
				ctx.restore;
			}
		}
		
		for(i=0; i<buttons.length; i++)
		{
			if(buttons[i].signal == EXIT)
			{
				ctx.drawImage(exit, (buttons[i].x*size-camX)*pixel, (buttons[i].y*size-size-camY)*pixel, size*pixel, size*pixel*2);
			}
		}
		
		ctx.drawImage(player, (playerX-camX)*pixel, (playerY-camY)*pixel, (playerSize)*pixel, playerSize*pixel);
		
		//кнопки
		for(i=0; i<buttons.length; i++)
		{
			if(buttons[i].signal != EXIT)
			{
				ctx.drawImage(button, (buttons[i].x*size-camX)*pixel, (buttons[i].y*size-camY)*pixel, size*pixel, size*pixel);
			}

		}
		
	}
	
	var key;
	var direction;
	function check(e)                                    
	{
		key = e.keyCode;
		if(key==right)
		{
			keyX=right;
		}
		if(key==left)
		{
			keyX=left;
		}
		if(key==up)
		{
			keyY=up;
		}
		
	}
	
	function reset(e)
	{
		key = e.keyCode;
		if(key==right || key==left)
		{
			keyX=0;
		}
		if(key==up)
		{
			keyY=0;
		}
		key = 0;
	}
	function checkBlocks()
	{
		if((blocks[playerCellY+1][playerCellX]==1 || blocks[playerCellY+1][playerCellX-1]==1 && Math.abs((playerCellX-1)*size-playerX)<playerSize ||blocks[playerCellY+1][playerCellX+1]==1 && Math.abs((playerCellX+1)*size-playerX)<playerSize) && Math.abs((playerCellY+1)*size-playerY)<=playerSize)
		{
			downBlock = 1;
			
			
		}else
		{
			downBlock = 0;
		}
		if((blocks[playerCellY-1][playerCellX]==1 || blocks[playerCellY-1][playerCellX-1]==1 && Math.abs((playerCellX-1)*size-playerX)<playerSize ||blocks[playerCellY-1][playerCellX+1]==1 && Math.abs((playerCellX+1)*size-playerX)<playerSize) && Math.abs((playerCellY-1)*size-playerY)<=size)
		{
			upBlock = 1; 
		}else
		{
			upBlock = 0;
		}
		if((blocks[playerCellY][playerCellX+1]!=0 || blocks[playerCellY+1][playerCellX+1]!=0 && Math.abs((playerCellY+1)*size-playerY)<playerSize || blocks[playerCellY-1][playerCellX+1]!=0 && Math.abs((playerCellY-1)*size-playerY)<playerSize) && Math.abs((playerCellX+1)*size-playerX)<=playerSize)
		{
			rightBlock = 1;console.log("RIGHT");
		}else
		{
			rightBlock = 0;
		}
		
		if((blocks[playerCellY][playerCellX-1]!=0 || blocks[playerCellY+1][playerCellX-1]!=0 && Math.abs((playerCellY+1)*size-playerY)<playerSize || blocks[playerCellY-1][playerCellX-1]!=0 && Math.abs((playerCellY-1)*size-playerY)<playerSize) && Math.abs((playerCellX-1)*size-playerX)<=size)
		{
			leftBlock = 1;console.log("LEFT");
		}else
		{
			leftBlock = 0;
		}
	}
	
	function jump(h)
	{
		forceY = -Math.sqrt(2*gravity*h);
	}

	function move()
	{
		cell();
		checkBlocks();
		if(keyX==right && forceX<=playerSpeed)
		{
			forceX += playerA;
			if(forceX>playerSpeed || downBlock==0){forceX=playerSpeed;}
		}else if(forceX>0 && downBlock==1)
		{
			forceX-=friction;
			if(forceX<0){forceX=0;}
		}
		if(keyX==left && forceX>=-playerSpeed)
		{
			forceX -= playerA;
			if(forceX<-playerSpeed || downBlock==0){forceX=-playerSpeed;}
		}else if(forceX<0 && downBlock==1)
		{
			forceX+=friction;
			if(forceX>0){forceX=0;}
		}
		
		if(keyY==up && downBlock==1)
		{
			jump(4*size);
		}
		
		if(downBlock == 0)
		{
			forceY+=gravity;
		}
		
		
		
		
		for(i=0; i<Math.abs(forceY); i++)
		{
			cell();
			checkBlocks();
			if(downBlock == 0 && forceY>0)
			{
				playerY+=1;
			}
			if(upBlock == 0 && forceY<0)
			{
				playerY-=1;
			}else if(upBlock == 1 || downBlock == 1 && keyY!=up)
			{
				forceY = 0;
			}
		}
		for(i=0; i<Math.abs(forceX); i++)
		{
			cell();
			checkBlocks();
			if(rightBlock == 0 && forceX>0)
			{
				playerX+=1;
			}
			if(leftBlock == 0 && forceX<0)
			{
				playerX-=1;
			}
			if(rightBlock == 1 || leftBlock == 1)
			{
				forceX = 0;
			}
		}
		
		if(blocks[playerCellY][Math.floor((playerX+size/2)/size)]==2)
		{
			deathSound.play();
			start();
		}
		
		if(rightBlock==1)
		{
			playerX-=1;
		}
		if(leftBlock==1)
		{
			playerX+=1;
		}
		
		
		//console.log(Math.abs((playerCellY+1)*size-playerY));
	}
		

		
	function camera()
	{
		
		camX += (playerX-screen.width/(2*pixel)-camX)/20;
		camY += (playerY-screen.height/(2*pixel)-camY)/20;
		
		camX = Math.round(camX);
		camY = Math.round(camY);
	}
	
	function checkDoors()
	{
		for(i=0; i<doors.length; i++)
		{
			if(playerIn(doors[i].x*size, doors[i].y*size, doors[i].x*size+size, doors[i].y*size+size*2) && key==space)
			{
				if(!doors[i].lock)
				{
					playerX = doors[i].endX*size;
					playerY = doors[i].endY*size;
					doorSound.play();
					key = 0;
				}
			}
		}
	}
	
	function checkButtons()
	{
		for(i=0; i<buttons.length; i++)
		{
			if(playerIn(buttons[i].x*size, buttons[i].y*size, buttons[i].x*size+size, buttons[i].y*size+size) && key==space)
			{
				signal = buttons[i].signal;
				console.log(signal);
				if(buttons[i].signal == EXIT)
				{
					doorSound.play();
				}else{
					buttonSound.play();
				}
				key = 0;
			}
		}
	}
	
	function start()
	{
		doors = [];
		buttons = [];
		levels[level].setup();
		sizeX = blocks.length;
		sizeY = blocks[0].length;
	}
	var forceX1;
	start();
	var time=0;
	function step()
	{
		forceX1 = forceX;
		checkWindow();
		move();
		/*if(key==up)
		{
			playerY-=20;
		}
		if(key==down)
		{
			playerY+=20;
		}
		if(key==right)
		{
			playerX+=20;
		}
		if(key==left)
		{
			playerX-=20;
		}*/
		camera();
		checkDoors();
		checkButtons();
		levels[level].play();
		if(signal == EXIT)
		{
			level++;
			start();
		}
		if(forceX!=0 && forceX1==0 && downBlock==1)
		{	
			walkSound.play();
		}
		if(forceX!=0 && time%6==0 && downBlock==1)
		{	
			walkSound.play();
		}
		//cell();
		//console.log(playerCellX, playerCellY);
		
		//key = 0;
		time++;
		draw();
		
	}
	draw();
	setInterval(step, 50);
</script>